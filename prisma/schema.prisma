// Sch√©ma de base de donn√©es pour le pipeline de commandes

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// √ânum√©ration des r√¥les utilisateurs
enum UserRole {
  ADMIN
  GESTIONNAIRE
  GESTIONNAIRE_STOCK
  APPELANT
  LIVREUR
}

// √ânum√©ration des statuts de commande
enum OrderStatus {
  NOUVELLE // Re√ßue depuis le site
  A_APPELER // En attente d'appel
  VALIDEE // Client a valid√© la commande
  ANNULEE // Client a annul√©
  INJOIGNABLE // Client non joignable
  ASSIGNEE // Assign√©e √† un livreur
  LIVREE // Livr√©e avec succ√®s
  REFUSEE // Refus√©e par le client √† la livraison
  ANNULEE_LIVRAISON // Annul√©e pendant la livraison
  RETOURNE // Retourn√© par le livreur (client absent, etc.)
  EXPEDITION // Paiement total 100% - Envoi vers autre ville
  EXPRESS // Paiement partiel 10% - Retrait en agence
  EXPRESS_ARRIVE // Colis arriv√© en agence - En attente paiement 90%
  EXPRESS_LIVRE // Express livr√© apr√®s paiement des 90%
}

// Type de livraison pour les villes √©loign√©es
enum DeliveryType {
  LOCAL // Livraison locale normale
  EXPEDITION // Paiement 100% avant envoi
  EXPRESS // Paiement 10% avant envoi, 90% √† la r√©ception
}

// Table des utilisateurs
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  nom       String
  prenom    String
  telephone String?
  role      UserRole
  actif     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ordersAsCaller       Order[]               @relation("CallerOrders")
  ordersAsDeliverer    Order[]               @relation("DelivererOrders")
  deliveryLists        DeliveryList[]
  callStats            CallStatistic[]
  deliveryStats        DeliveryStatistic[]
  expressNotifications ExpressNotification[]

  // Chat
  conversationsCreated     Conversation[]            @relation("ConversationCreator")
  conversationParticipants ConversationParticipant[] @relation("ChatParticipants")
  messagesSent             Message[]                 @relation("MessageSender")
  messageReads             MessageRead[]             @relation("MessageReads")
  messageReactions         MessageReaction[]         @relation("MessageReactions")

  @@map("users")
}

// Table des commandes
model Order {
  id             Int    @id @default(autoincrement())
  orderReference String @unique @default(uuid())

  // Informations client
  clientNom       String
  clientTelephone String
  clientVille     String
  clientCommune   String?
  clientAdresse   String?

  // Informations produit
  produitNom  String
  produitPage String?
  productId   Int? // Lien vers le produit (optionnel pour r√©trocompatibilit√©)
  product     Product? @relation("ProductOrders", fields: [productId], references: [id])
  quantite    Int      @default(1)
  montant     Float

  // Gestion des paiements (pour EXPEDITION & EXPRESS)
  deliveryType     DeliveryType @default(LOCAL)
  montantPaye      Float? // Montant d√©j√† pay√© (10% pour EXPRESS, 100% pour EXPEDITION)
  montantRestant   Float? // Montant restant √† payer (90% pour EXPRESS)
  modePaiement     String? // Mobile Money, Cash, etc.
  referencePayment String? // R√©f√©rence de transaction Mobile Money

  // Informations marketing
  sourceCampagne String?
  sourcePage     String?

  // Statut et pipeline
  status OrderStatus @default(NOUVELLE)

  // Assignations
  callerId     Int?
  caller       User?     @relation("CallerOrders", fields: [callerId], references: [id])
  calledAt     DateTime?
  nombreAppels Int       @default(0) // Nombre de tentatives d'appel

  delivererId    Int?
  deliverer      User?         @relation("DelivererOrders", fields: [delivererId], references: [id])
  deliveryDate   DateTime?
  deliveryListId Int?
  deliveryList   DeliveryList? @relation(fields: [deliveryListId], references: [id])

  // Notes internes
  noteAppelant     String?
  noteLivreur      String?
  noteGestionnaire String?

  // Gestion des retours
  raisonRetour String? // Raison du retour (client absent, refuse, adresse incorrecte, etc.)
  retourneAt   DateTime? // Date du retour

  // Gestion EXPEDITION - Code de suivi
  codeExpedition                String? // Code d'exp√©dition/tracking fourni par le livreur
  photoRecuExpedition           String? // Photo du re√ßu d'exp√©dition (base64 ou URL)
  photoRecuExpeditionUploadedAt DateTime? // Date d'upload de la photo (pour suppression auto apr√®s 7j)

  // Gestion EXPRESS - Notification d'arriv√©e
  clientNotifie Boolean?  @default(false) // Client notifi√© de l'arriv√©e du colis
  notifieAt     DateTime? // Date de notification du client
  notifiePar    Int? // Appelant qui a notifi√©
  agenceRetrait String? // Nom de l'agence de retrait

  // Statut paiement EXPEDITION
  enAttentePaiement Boolean   @default(false) // Commande en attente de paiement (pour EXPEDITION)
  attentePaiementAt DateTime? // Date de mise en attente de paiement

  // Gestion des RDV (Rendez-vous pour rappel)
  rdvProgramme    Boolean   @default(false) // RDV programm√© pour rappeler le client
  rdvDate         DateTime? // Date et heure du RDV
  rdvNote         String? // Note sur le RDV (client occup√©, en voyage, etc.)
  rdvProgrammePar Int? // ID de l'appelant qui a programm√© le RDV
  rdvRappele      Boolean   @default(false) // RDV trait√© (client rappel√©)

  // Dates de suivi
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  validatedAt DateTime?
  deliveredAt DateTime?
  expedieAt   DateTime? // Date d'exp√©dition (pour EXPEDITION et EXPRESS)
  arriveAt    DateTime? // Date d'arriv√©e en agence (pour EXPRESS)

  // Historique des changements de statut
  statusHistory StatusHistory[]

  // Notifications EXPRESS
  expressNotifications ExpressNotification[]

  @@index([status])
  @@index([clientTelephone])
  @@index([clientVille])
  @@index([deliveryDate])
  @@index([callerId])
  @@index([delivererId])
  @@map("orders")
}

// Historique des changements de statut
model StatusHistory {
  id        Int          @id @default(autoincrement())
  orderId   Int
  order     Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  oldStatus OrderStatus?
  newStatus OrderStatus
  changedBy Int
  comment   String?
  createdAt DateTime     @default(now())

  @@index([orderId])
  @@map("status_history")
}

// Listes de livraison journali√®res
model DeliveryList {
  id           Int           @id @default(autoincrement())
  nom          String
  date         DateTime
  delivererId  Int
  deliverer    User          @relation(fields: [delivererId], references: [id])
  zone         String? // Zone g√©ographique
  orders       Order[]
  tourneeStock TourneeStock? // Lien avec la gestion de stock
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([delivererId, date])
  @@map("delivery_lists")
}

// Statistiques d'appels (pour les appelants)
model CallStatistic {
  id     Int      @id @default(autoincrement())
  userId Int
  user   User     @relation(fields: [userId], references: [id])
  date   DateTime @default(now())

  totalAppels       Int @default(0)
  totalValides      Int @default(0)
  totalAnnules      Int @default(0)
  totalInjoignables Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@map("call_statistics")
}

// Statistiques de livraison (pour les livreurs)
model DeliveryStatistic {
  id     Int      @id @default(autoincrement())
  userId Int
  user   User     @relation(fields: [userId], references: [id])
  date   DateTime @default(now())

  totalLivraisons Int   @default(0)
  totalRefusees   Int   @default(0)
  totalAnnulees   Int   @default(0)
  montantLivre    Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@map("delivery_statistics")
}

// Notifications pour les EXPRESS en agence
model ExpressNotification {
  id         Int      @id @default(autoincrement())
  orderId    Int
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId     Int // Appelant qui a notifi√©
  user       User     @relation(fields: [userId], references: [id])
  note       String? // Raison du non-retrait (occup√©, voyage, etc.)
  notifiedAt DateTime @default(now())

  @@index([orderId])
  @@index([userId])
  @@map("express_notifications")
}

// ========================================
// CHAT ENTREPRISE
// ========================================

// Conversations (priv√©es ou groupes)
model Conversation {
  id          Int              @id @default(autoincrement())
  type        ConversationType @default(PRIVATE) // PRIVATE, GROUP, BROADCAST
  name        String? // Nom du groupe (si type = GROUP)
  description String? // Description du groupe
  createdBy   Int
  creator     User             @relation("ConversationCreator", fields: [createdBy], references: [id])

  // Participants
  participants ConversationParticipant[]
  messages     Message[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastMessageAt DateTime? // Date du dernier message (pour tri)

  @@index([type])
  @@index([lastMessageAt])
  @@map("conversations")
}

// Participants d'une conversation
model ConversationParticipant {
  id             Int          @id @default(autoincrement())
  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         Int
  user           User         @relation("ChatParticipants", fields: [userId], references: [id])

  // Permissions
  isAdmin Boolean @default(false) // Admin du groupe (peut ajouter/retirer membres)
  isMuted Boolean @default(false) // Notifications d√©sactiv√©es pour cette conv

  // Suivi
  lastReadAt DateTime? // Derni√®re fois que l'utilisateur a lu les messages
  joinedAt   DateTime  @default(now())

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
  @@map("conversation_participants")
}

// Messages
model Message {
  id             Int          @id @default(autoincrement())
  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       Int
  sender         User         @relation("MessageSender", fields: [senderId], references: [id])

  // Contenu
  content String?     @db.Text // Texte du message
  type    MessageType @default(TEXT) // TEXT, IMAGE, FILE, SYSTEM

  // Fichiers joints
  fileUrl      String? // URL du fichier/image upload√©
  fileName     String? // Nom original du fichier
  fileSize     Int? // Taille en octets
  fileMimeType String? // Type MIME (image/png, application/pdf, etc.)

  // M√©tadonn√©es
  isEdited  Boolean   @default(false)
  isPinned  Boolean   @default(false) // Message √©pingl√©
  replyToId Int? // ID du message auquel on r√©pond
  replyTo   Message?  @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies   Message[] @relation("MessageReplies")

  // Suivi
  reads     MessageRead[]
  reactions MessageReaction[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

// Lecture des messages (pour savoir qui a lu quoi)
model MessageRead {
  id        Int      @id @default(autoincrement())
  messageId Int
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    Int
  user      User     @relation("MessageReads", fields: [userId], references: [id])
  readAt    DateTime @default(now())

  @@unique([messageId, userId])
  @@index([userId])
  @@index([messageId])
  @@map("message_reads")
}

// R√©actions aux messages (emojis)
model MessageReaction {
  id        Int      @id @default(autoincrement())
  messageId Int
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    Int
  user      User     @relation("MessageReactions", fields: [userId], references: [id])
  emoji     String // Unicode emoji (üëç, ‚ù§Ô∏è, üòÇ, etc.)
  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@map("message_reactions")
}

enum ConversationType {
  PRIVATE // Conversation priv√©e (1-1)
  GROUP // Groupe/Channel
  BROADCAST // Message broadcast (annonces globales)
}

enum MessageType {
  TEXT // Message texte
  IMAGE // Image
  FILE // Fichier (PDF, doc, etc.)
  SYSTEM // Message syst√®me (X a rejoint, Y a quitt√©, etc.)
}

// ========================================
// NOUVEAU : GESTION DE STOCK
// ========================================

// Table des produits
model Product {
  id                Int      @id @default(autoincrement())
  code              String   @unique // Code/r√©f√©rence produit
  nom               String
  description       String?
  prixUnitaire      Float
  stockActuel       Int      @default(0) // Stock disponible normal
  stockExpress      Int      @default(0) // Stock r√©serv√© EXPRESS (pay√© 10%, en attente retrait)
  stockLocalReserve Int      @default(0) // Stock r√©serv√© en livraison locale (avec livreurs)
  stockAlerte       Int      @default(10) // Seuil d'alerte
  actif             Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  stockMovements StockMovement[]
  orders         Order[]         @relation("ProductOrders")

  @@index([code])
  @@index([actif])
  @@map("products")
}

// Types de mouvements de stock
enum StockMovementType {
  APPROVISIONNEMENT // Ajout de stock manuel par admin
  LIVRAISON // Sortie de stock (commande livr√©e)
  RETOUR // Retour de colis non livr√©
  CORRECTION // Correction manuelle
  PERTE // Perte/casse
  RESERVATION // R√©servation stock pour EXP√âDITION (100% pay√©)
  RESERVATION_EXPRESS // D√©placement vers stock EXPRESS (10% pay√©)
  RETRAIT_EXPRESS // Sortie du stock EXPRESS (client a retir√©)
  ANNULATION_EXPRESS // Annulation EXPRESS, retour au stock normal
  RESERVATION_LOCAL // D√©placement vers stock local r√©serv√© (avec livreur)
  LIVRAISON_LOCAL // Sortie du stock local r√©serv√© (livraison r√©ussie)
  RETOUR_LOCAL // Retour du stock local r√©serv√© vers stock normal
  CORRECTION_LIVRAISON_LOCAL // Correction < 24h LOCAL : retour dans stockLocalReserve
  RETOUR_EXPEDITION // Correction < 24h EXPEDITION : retour dans stockActuel
  CORRECTION_EXPRESS // Correction < 24h EXPRESS : retour dans stockExpress
  AJUSTEMENT // Ajustement manuel par admin (entr√©e/sortie)
}

// Mouvements de stock (entr√©es/sorties)
model StockMovement {
  id        Int     @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id])

  type       StockMovementType
  quantite   Int // Positif pour entr√©e, n√©gatif pour sortie
  stockAvant Int // Stock avant le mouvement
  stockApres Int // Stock apr√®s le mouvement

  // R√©f√©rences optionnelles
  orderId   Int? // Si li√© √† une commande
  tourneeId Int? // Si li√© √† une tourn√©e
  tournee   TourneeStock? @relation(fields: [tourneeId], references: [id])

  effectuePar Int // User qui a effectu√© le mouvement
  motif       String? // Raison du mouvement

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@index([tourneeId])
  @@map("stock_movements")
}

// Gestion des tourn√©es c√¥t√© stock (colis remis/retourn√©s)
model TourneeStock {
  id             Int          @id @default(autoincrement())
  deliveryListId Int          @unique
  deliveryList   DeliveryList @relation(fields: [deliveryListId], references: [id])

  // Colis remis au d√©part
  colisRemis         Int       @default(0)
  colisRemisConfirme Boolean   @default(false)
  colisRemisAt       DateTime?
  colisRemisBy       Int? // Gestionnaire de stock qui a confirm√©

  // Retour apr√®s tourn√©e
  colisLivres         Int       @default(0) // Calcul√© automatiquement depuis les commandes
  colisRetour         Int       @default(0)
  colisRetourConfirme Boolean   @default(false)
  colisRetourAt       DateTime?
  colisRetourBy       Int? // Gestionnaire de stock qui a enregistr√©

  // V√©rification
  ecart       Int     @default(0) // colisRemis - (colisLivres + colisRetour)
  ecartResolu Boolean @default(false)
  ecartMotif  String? // Explication si √©cart (perte, casse, etc.)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  stockMovements StockMovement[]

  @@index([deliveryListId])
  @@index([colisRemisConfirme])
  @@index([colisRetourConfirme])
  @@map("tournees_stock")
}
