name: Migrate Railway -> Supabase (online)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Mode"
        required: true
        default: "migrate"
        type: choice
        options:
          - migrate
          - verify_only

jobs:
  migrate:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare PostgreSQL client (v17)
        shell: bash
        run: |
          set -euo pipefail
          docker --version
          docker pull postgres:17

      - name: Validate inputs / files
        shell: bash
        run: |
          set -euo pipefail
          test -f "supabase-cleanup.sql"
          test -f "supabase-schema-utf8.sql"
          test -f "backups/prepare-import-supabase.sql"
          test -f "supabase-reset-sequences.sql"
          echo "OK: fichiers SQL présents"

      - name: Verify connections (quick)
        shell: bash
        env:
          RAILWAY_DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
          SUPABASE_DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
        run: |
          set -euo pipefail
          if [ -z "${RAILWAY_DATABASE_URL:-}" ]; then
            echo "Missing secret: RAILWAY_DATABASE_URL" >&2
            exit 1
          fi
          if [ -z "${SUPABASE_DATABASE_URL:-}" ]; then
            echo "Missing secret: SUPABASE_DATABASE_URL" >&2
            exit 1
          fi

          # Afficher les URLs sans fuite de mot de passe (debug)
          sanitize_url() {
            # remplace password par ***
            echo "$1" | sed -E 's#(postgres(ql)?://[^:]+):[^@]+@#\1:***@#'
          }
          echo "Railway (sanitized): $(sanitize_url "${RAILWAY_DATABASE_URL}")"
          echo "Supabase (sanitized): $(sanitize_url "${SUPABASE_DATABASE_URL}")"

          echo "Testing Railway..."
          docker run --rm \
            -e RAILWAY_DATABASE_URL \
            -v "$PWD:/work" -w /work \
            postgres:17 \
            bash -lc 'psql "$RAILWAY_DATABASE_URL" -v ON_ERROR_STOP=1 -c "SELECT 1;"'
          echo "Testing Supabase..."
          docker run --rm \
            -e SUPABASE_DATABASE_URL \
            -e PGSSLMODE=require \
            -v "$PWD:/work" -w /work \
            postgres:17 \
            bash -lc 'psql "$SUPABASE_DATABASE_URL" -v ON_ERROR_STOP=1 -c "SELECT 1;"'

      - name: Migrate (schema + data)
        if: ${{ inputs.mode == 'migrate' }}
        shell: bash
        env:
          RAILWAY_DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
          SUPABASE_DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
        run: |
          set -euo pipefail
          docker run --rm \
            -e RAILWAY_DATABASE_URL \
            -e SUPABASE_DATABASE_URL \
            -e PGSSLMODE=require \
            -e PGOPTIONS='-c statement_timeout=0' \
            -v "$PWD:/work" -w /work \
            postgres:17 \
            bash -lc '
              set -euo pipefail

              echo "1) Nettoyage Supabase..."
              psql "$SUPABASE_DATABASE_URL" -v ON_ERROR_STOP=1 -f "supabase-cleanup.sql"

              echo "2) Création schéma Supabase..."
              psql "$SUPABASE_DATABASE_URL" -v ON_ERROR_STOP=1 -f "supabase-schema-utf8.sql"

              echo "3) Préparation import (FK deferrable + truncate/restart)..."
              psql "$SUPABASE_DATABASE_URL" -v ON_ERROR_STOP=1 -f "backups/prepare-import-supabase.sql"

              echo "4) Copie des données Railway -> Supabase (pg_dump | psql)..."
              pg_dump "$RAILWAY_DATABASE_URL" \
                --data-only \
                --inserts \
                --column-inserts \
                --no-owner \
                --no-privileges \
                --verbose \
              | psql "$SUPABASE_DATABASE_URL" -v ON_ERROR_STOP=1 -1

              echo "5) Recalage des séquences (SERIAL)..."
              psql "$SUPABASE_DATABASE_URL" -v ON_ERROR_STOP=1 -f "supabase-reset-sequences.sql"

              echo "✅ Migration terminée."
            '

          echo "✅ Migration terminée."

      - name: Verify counts (basic)
        if: ${{ always() }}
        shell: bash
        env:
          SUPABASE_DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
        run: |
          set -euo pipefail
          if [ -z "${SUPABASE_DATABASE_URL:-}" ]; then
            echo "Missing secret: SUPABASE_DATABASE_URL" >&2
            exit 1
          fi
          echo "Comptages rapides:"
          docker run --rm \
            -e SUPABASE_DATABASE_URL \
            -e PGSSLMODE=require \
            -v "$PWD:/work" -w /work \
            postgres:17 \
            bash -lc '
              set -euo pipefail
              psql "$SUPABASE_DATABASE_URL" -v ON_ERROR_STOP=1 -c "SELECT '\''users'\'' as table, COUNT(*)::bigint as count FROM public.users;"
              psql "$SUPABASE_DATABASE_URL" -v ON_ERROR_STOP=1 -c "SELECT '\''products'\'' as table, COUNT(*)::bigint as count FROM public.products;"
              psql "$SUPABASE_DATABASE_URL" -v ON_ERROR_STOP=1 -c "SELECT '\''orders'\'' as table, COUNT(*)::bigint as count FROM public.orders;"
            '

