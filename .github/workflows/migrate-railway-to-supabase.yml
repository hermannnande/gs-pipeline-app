name: Migrate Railway -> Supabase (online)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Mode"
        required: true
        default: "migrate"
        type: choice
        options:
          - migrate
          - verify_only

jobs:
  migrate:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Validate inputs / files
        shell: bash
        run: |
          set -euo pipefail
          test -f "supabase-cleanup.sql"
          test -f "supabase-schema-utf8.sql"
          test -f "backups/prepare-import-supabase.sql"
          echo "OK: fichiers SQL présents"

      - name: Verify connections (quick)
        shell: bash
        env:
          RAILWAY_DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
          SUPABASE_DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
        run: |
          set -euo pipefail
          if [ -z "${RAILWAY_DATABASE_URL:-}" ]; then
            echo "Missing secret: RAILWAY_DATABASE_URL" >&2
            exit 1
          fi
          if [ -z "${SUPABASE_DATABASE_URL:-}" ]; then
            echo "Missing secret: SUPABASE_DATABASE_URL" >&2
            exit 1
          fi
          echo "Testing Railway..."
          psql "${RAILWAY_DATABASE_URL}" -v ON_ERROR_STOP=1 -c "SELECT 1;"
          echo "Testing Supabase..."
          psql "${SUPABASE_DATABASE_URL}" -v ON_ERROR_STOP=1 -c "SELECT 1;"

      - name: Migrate (schema + data)
        if: ${{ inputs.mode == 'migrate' }}
        shell: bash
        env:
          RAILWAY_DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
          SUPABASE_DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
        run: |
          set -euo pipefail
          echo "1) Nettoyage Supabase..."
          psql "${SUPABASE_DATABASE_URL}" -v ON_ERROR_STOP=1 -f "supabase-cleanup.sql"

          echo "2) Création schéma Supabase..."
          psql "${SUPABASE_DATABASE_URL}" -v ON_ERROR_STOP=1 -f "supabase-schema-utf8.sql"

          echo "3) Préparation import (FK deferrable + truncate/restart)..."
          psql "${SUPABASE_DATABASE_URL}" -v ON_ERROR_STOP=1 -f "backups/prepare-import-supabase.sql"

          echo "4) Copie des données Railway -> Supabase (pg_dump | psql)..."
          # Important: on utilise INSERTs (compatible pooler) et on évite les éléments de schéma.
          # --column-inserts facilite la compatibilité si l'ordre des colonnes change.
          # --data-only évite les CREATE TYPE/TABLE.
          pg_dump "${RAILWAY_DATABASE_URL}" \
            --data-only \
            --inserts \
            --column-inserts \
            --no-owner \
            --no-privileges \
            --verbose \
          | psql "${SUPABASE_DATABASE_URL}" -v ON_ERROR_STOP=1

          echo "✅ Migration terminée."

      - name: Verify counts (basic)
        if: ${{ always() }}
        shell: bash
        env:
          SUPABASE_DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
        run: |
          set -euo pipefail
          if [ -z "${SUPABASE_DATABASE_URL:-}" ]; then
            echo "Missing secret: SUPABASE_DATABASE_URL" >&2
            exit 1
          fi
          echo "Comptages rapides:"
          psql "${SUPABASE_DATABASE_URL}" -v ON_ERROR_STOP=1 -c "SELECT 'users' as table, COUNT(*)::bigint as count FROM public.users;"
          psql "${SUPABASE_DATABASE_URL}" -v ON_ERROR_STOP=1 -c "SELECT 'products' as table, COUNT(*)::bigint as count FROM public.products;"
          psql "${SUPABASE_DATABASE_URL}" -v ON_ERROR_STOP=1 -c "SELECT 'orders' as table, COUNT(*)::bigint as count FROM public.orders;"

